/*
This model represents the deterministic mean-field equations of chimeric antigen receptor (CAR) T cell therapy dynamics, as described in Kimmel et al. (2021). The model captures the interactions among three cell populations: normal T cells (N), CAR T cells (C), and tumor cells (B). The dynamics are governed by a system of ordinary differential equations that describe competitive Gompertz growth for T cells and CAR T cells, and logistic-like growth and CAR T-cell-mediated killing for tumor cells.

Reference:
Kimmel GJ, Locke FL, Altrock PM. 2021 The roles of T cell competition and stochastic extinction events in chimeric antigen receptor T cell therapy. Proc. R. Soc. B 288: 20210229.
https://doi.orgorg/10.1098/rspb.2021.0229
*/

model *Kimmel2021_CARTcell_dynamics()

    //// Compartments and Species:
    compartment patient;
    species N in patient, C in patient, B in patient;

    //// Assignment Rules:
    T := N + C;
    r_C := rho_C + (b*(T - K_N)^2) / (a*T^2 + (T - K_N)^2);

    //// Rate Rules:
    N' = -r_N * N * log((N + C) / K_N);
    C' = -r_C * C * log((N + C) / K_C);
    B' = r_B * B - gamma_B * B * C / (k_B + C);

    //// Species initializations:
    N = 3.00e9;   // Initial median normal T cell number (cells)
    C = 1.80e8;   // Initial CAR T cell number (cells)
    B = 9.486e10; // Initial median tumour cell number (cells)

    //// Compartment initializations:
    patient = 1;  // Volume is unitless as the model tracks cell counts

    //// Variable initializations:
    K_N = 2.50e11;  // Normal T cell carrying capacity (cells)
    K_C = 6.96e10;  // CAR T cell carrying capacity (cells)
    r_N = 0.170;    // Normal T cell net growth rate (day^-1)
    rho_C = 0.0251; // Baseline CAR T net growth rate (day^-1)
    a = 0.423;      // Signalling inefficiency factor in r_C (dimensionless)
    b = 0.525;      // Immune reconstitution impact in r_C (day^-1)
    r_B = 0.19;     // Tumour net growth rate (day^-1). Medium growth rate from Fig 3b. Range [0.01, 0.5] from literature.
    gamma_B = 1.15; // Tumour-killing rate (day^-1)
    k_B = 2.024e9;  // Killing rate saturation parameter (cells)

    //// Other declarations:
    var T, r_C;
    const patient, K_N, K_C, r_N, rho_C, a, b, r_B, gamma_B, k_B;

    //// Display Names:
    N is "Normal T cells";
    C is "CAR T cells";
    B is "Tumour cells";
    patient is "Patient";
    T is "Total lymphocyte count";
    r_C is "CAR T cell growth rate function";
    K_N is "Normal T cell carrying capacity";
    K_C is "CAR T cell carrying capacity";
    r_N is "Normal T cell net growth rate";
    rho_C is "Baseline CAR T net growth rate";
    a is "Signalling inefficiency factor in r_C";
    b is "Immune reconstitution impact in r_C";
    r_B is "Tumour net growth rate";
    gamma_B is "Tumour-killing rate";
    k_B is "Killing rate saturation parameter";

end
